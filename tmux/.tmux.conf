# --- General ---
set -g default-terminal "tmux-256color"
set -ag terminal-overrides ",xterm-256color:RGB"
set -g mouse on
set -g base-index 1
setw -g pane-base-index 1
set -g renumber-windows on
set -g history-limit 50000
set -g set-clipboard on
set -g allow-passthrough on
set -ga update-environment TERM
set -ga update-environment TERM_PROGRAM
set -sg escape-time 0
set -g focus-events on
set -g detach-on-destroy off

# --- Prefix ---
set -g prefix C-b
set -g prefix2 C-a
bind C-a send-prefix -2

# --- Splits (retain current directory) ---
bind | split-window -h -c "#{pane_current_path}"
bind - split-window -v -c "#{pane_current_path}"
bind c new-window -c "#{pane_current_path}"
unbind '"'
unbind %

# --- Vim-tmux-navigator (seamless C-h/j/k/l between nvim splits and tmux panes) ---
is_vim="ps -o state= -o comm= -t '#{pane_tty}' | grep -iqE '^[^TXZ ]+ +(\\S+\\/)?g?(view|l?n?vim?x?|fzf)(diff)?$'"
bind -n C-h if-shell "$is_vim" "send-keys C-h" "select-pane -L"
bind -n C-j if-shell "$is_vim" "send-keys C-j" "select-pane -D"
bind -n C-k if-shell "$is_vim" "send-keys C-k" "select-pane -U"
bind -n C-l if-shell "$is_vim" "send-keys C-l" "select-pane -R"
bind -n C-\\ if-shell "$is_vim" "send-keys C-\\\\" "select-pane -l"

# Also keep prefix+hjkl as fallback
bind h select-pane -L
bind j select-pane -D
bind k select-pane -U
bind l select-pane -R

# --- Pane resizing ---
bind -r H resize-pane -L 5
bind -r J resize-pane -D 5
bind -r K resize-pane -U 5
bind -r L resize-pane -R 5

# --- Vi copy mode ---
setw -g mode-keys vi
bind -T copy-mode-vi v send-keys -X begin-selection
bind -T copy-mode-vi y send-keys -X copy-selection-and-cancel
bind -T copy-mode-vi C-v send-keys -X rectangle-toggle

# --- Sesh (session manager) ---
bind -N "Sesh session switcher" T run-shell "sesh connect \"$(
  sesh list --icons | fzf-tmux -p 80%,70% \
    --no-sort --ansi --border-label ' sesh ' --prompt '  ' \
    --header '  ^a all  ^t tmux  ^x zoxide  ^d kill  ^f find' \
    --bind 'tab:down,btab:up' \
    --bind 'ctrl-a:change-prompt(  )+reload(sesh list --icons)' \
    --bind 'ctrl-t:change-prompt(  )+reload(sesh list -t --icons)' \
    --bind 'ctrl-x:change-prompt(  )+reload(sesh list -z --icons)' \
    --bind 'ctrl-f:change-prompt(  )+reload(fd -H -d 2 -t d -E .git . ~)' \
    --bind 'ctrl-d:execute(tmux kill-session -t {2..})+change-prompt(  )+reload(sesh list --icons)' \
    --preview 'sesh preview {2..}' \
)\""

# --- Reload config ---
bind r source-file ~/.tmux.conf \; display-message "Config reloaded"

# --- Tokyo Night Theme (Night variant) ---
# Palette reference:
#   bg=#1a1b26  fg=#c0caf5  blue=#7aa2f7  purple=#9d7cd8
#   cyan=#7dcfff  green=#9ece6a  red=#f7768e  yellow=#e0af68
#   comment=#565f89  dark5=#394b70  bg_highlight=#283457

# Status bar
set -g status-position top
set -g status-style "bg=#1a1b26,fg=#c0caf5"
set -g status-left-length 40
set -g status-right-length 60
set -g status-left "#[bg=#7aa2f7,fg=#1a1b26,bold] #S #[bg=#1a1b26,fg=#7aa2f7]"
set -g status-right "#[fg=#394b70]#[bg=#394b70,fg=#c0caf5] %H:%M #[bg=#7aa2f7,fg=#1a1b26,bold] #h "
set -g window-status-format "#[fg=#565f89] #I:#W "
set -g window-status-current-format "#[fg=#9d7cd8,bold] #I:#W "

# Pane borders
set -g pane-border-style "fg=#394b70"
set -g pane-active-border-style "fg=#7aa2f7"

# Messages & command line
set -g message-style "bg=#1a1b26,fg=#7aa2f7"
set -g message-command-style "bg=#283457,fg=#c0caf5"

# Copy mode highlight
set -g mode-style "bg=#283457,fg=#c0caf5"

# Clock
set -g clock-mode-colour "#7aa2f7"

# --- TPM (auto-bootstrap) ---
if "test ! -d ~/.tmux/plugins/tpm" \
   "run 'git clone https://github.com/tmux-plugins/tpm ~/.tmux/plugins/tpm'"

set -g @plugin 'tmux-plugins/tpm'
set -g @plugin 'tmux-plugins/tmux-sensible'
set -g @plugin 'tmux-plugins/tmux-yank'
set -g @plugin 'tmux-plugins/tmux-resurrect'
set -g @plugin 'tmux-plugins/tmux-continuum'
set -g @plugin 'fcsonline/tmux-thumbs'

# --- Resurrect & Continuum ---
set -g @resurrect-capture-pane-contents 'on'
set -g @resurrect-strategy-nvim 'session'
set -g @continuum-restore 'on'
set -g @continuum-save-interval '15'

# --- Thumbs (quick-copy visible text) ---
set -g @thumbs-key F
set -g @thumbs-contrast 1
set -g @thumbs-bg-color "#1a1b26"
set -g @thumbs-fg-color "#7aa2f7"
set -g @thumbs-hint-fg-color "#9d7cd8"
set -g @thumbs-select-fg-color "#9ece6a"

run '~/.tmux/plugins/tpm/tpm'
